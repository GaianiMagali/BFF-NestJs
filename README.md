# üöÄ BFF NestJS - Arquitectura Hexagonal

Backend For Frontend (BFF) desarrollado con NestJS siguiendo patrones de **Arquitectura Hexagonal** para validaci√≥n de tokens JWT y obtenci√≥n de informaci√≥n de usuario.

## üìã Tabla de Contenidos

- [Caracter√≠sticas](#caracter√≠sticas)
- [Arquitectura](#arquitectura)
- [Requisitos](#requisitos)
- [Instalaci√≥n](#instalaci√≥n)
- [Configuraci√≥n](#configuraci√≥n)
- [Ejecuci√≥n](#ejecuci√≥n)
- [API Endpoints](#api-endpoints)
- [Testing](#testing)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [Tecnolog√≠as](#tecnolog√≠as)

## ‚ú® Caracter√≠sticas

- üèóÔ∏è **Arquitectura Hexagonal** - Separaci√≥n limpia de responsabilidades
- üîê **Validaci√≥n JWT** - Decodificaci√≥n sin verificaci√≥n de firma
- üîÑ **Token Renovation** - Obtenci√≥n de tokens renovados de API externa
- üåê **Integraci√≥n APIs** - Comunicaci√≥n con servicios externos
- üìö **Swagger Documentation** - API completamente documentada
- üõ°Ô∏è **Guards & Filters** - Manejo robusto de errores y seguridad
- üîß **Variables de Entorno** - Configuraci√≥n flexible por ambiente
- üîÑ **Hot Reload** - Desarrollo con recarga autom√°tica

## üèóÔ∏è Arquitectura

### Arquitectura Hexagonal (Ports & Adapters)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Presentation     ‚îÇ  ‚Üê Controllers, DTOs
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    Application      ‚îÇ  ‚Üê Use Cases, DTOs
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      Domain         ‚îÇ  ‚Üê Entities, Repositories
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Infrastructure    ‚îÇ  ‚Üê Adapters, Guards, Filters
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Flujo Detallado de Datos

### Arquitectura de Capas

```mermaid
graph TB
    subgraph "üåê Cliente"
        Client[Frontend/Postman]
    end
    
    subgraph "üé® PRESENTATION Layer"
        Controller[AuthController]
        Guard[TokenValidationGuard]
    end
    
    subgraph "üìã APPLICATION Layer"  
        UseCase[ValidateTokenUseCase]
        DTOs[DTOs Response]
    end
    
    subgraph "üìä DOMAIN Layer"
        Entity[Token Entity]
        Exceptions[Domain Exceptions]
    end
    
    subgraph "üîß INFRASTRUCTURE Layer"
        JWTAdapter[JWT Adapter]
        ValidationAdapter[Token Validation Adapter]
        UserAdapter[User API Adapter]
        Filter[Exception Filter]
    end
    
    subgraph "üåç External Services"
        ValidationAPI[Token Validation API]
        UserAPI[User Info API]
    end

    Client --> Controller
    Controller --> Guard
    Guard --> UseCase
    UseCase --> Entity
    UseCase --> JWTAdapter
    UseCase --> ValidationAdapter
    UseCase --> UserAdapter
    ValidationAdapter --> ValidationAPI
    UserAdapter --> UserAPI
    Exceptions --> Filter
    DTOs --> Controller
```

### Flujo Paso a Paso con Componentes

```mermaid
sequenceDiagram
    participant C as üåê Cliente
    participant G as üõ°Ô∏è Guard
    participant UC as üìã UseCase
    participant JWT as üîê JWT Adapter
    participant VA as ‚úÖ Validation Adapter
    participant UA as üë§ User Adapter
    participant E as üìä Token Entity
    participant Ctrl as üéØ Controller
    participant F as üö® Exception Filter
    participant ExtAPI1 as üåç Validation API
    participant ExtAPI2 as üåç User API

    Note over C: 1. Request con Token
    C->>G: GET /api<br/>Authorization: Bearer <token>
    
    Note over G: 2. Extracci√≥n y Validaci√≥n
    G->>UC: validateToken(token)
    
    Note over UC: 3. Decodificaci√≥n JWT
    UC->>JWT: validateToken(token)
    JWT->>E: new Token(payload)
    E->>UC: Token entity
    
    alt Token expirado
        UC->>F: throw TokenExpiredException
        F->>C: 401 + error details
    else Token v√°lido
        Note over UC: 4. Validaci√≥n Externa
        UC->>VA: validateAndRenewToken(token)
        VA->>ExtAPI1: POST /validate
        ExtAPI1->>VA: renewed_token
        VA->>UC: renewed_token
        
        Note over UC: 5. Obtener Info Usuario
        UC->>UA: getUserInfo(renewed_token)
        UA->>ExtAPI2: GET /users/1
        ExtAPI2->>UA: user_data
        UA->>UC: user_data
        
        Note over UC: 6. Respuesta Exitosa
        UC->>G: { isValid: true, token, userInfo }
        G->>Ctrl: request.user = token<br/>request.userInfo = userInfo
        Ctrl->>C: 200 + ValidateTokenResponseDto
    end
```

### Flujo de Datos por Capa

```mermaid
flowchart LR
    subgraph Input["üì• INPUT"]
        A[Authorization: Bearer eyJ...]
    end
    
    subgraph Presentation["üé® PRESENTATION"]
        B[Guard extrae token]
        C[Controller formatea respuesta]
    end
    
    subgraph Application["üìã APPLICATION"]
        D[UseCase orquesta validaci√≥n]
        E[DTOs estructuran datos]
    end
    
    subgraph Domain["üìä DOMAIN"]
        F[Token Entity valida payload]
        G[Exceptions manejan errores]
    end
    
    subgraph Infrastructure["üîß INFRASTRUCTURE"]
        H[JWT Adapter decodifica]
        I[HTTP Adapters llaman APIs]
        J[Exception Filter formatea errores]
    end
    
    subgraph External["üåç EXTERNAL"]
        K[Validation API renueva token]
        L[User API retorna datos]
    end
    
    subgraph Output["üì§ OUTPUT"]
        M[JSON Response estructurado]
    end

    A --> B
    B --> D
    D --> F
    D --> H
    D --> I
    H --> D
    I --> K
    I --> L
    K --> I
    L --> I
    I --> D
    F --> D
    D --> B
    B --> C
    C --> E
    E --> M
    
    G --> J
    J --> M
```

## üìä Datos que Viajan entre Componentes

### üîÑ Transformaci√≥n de Datos

| Componente | Input | Output | Prop√≥sito |
|------------|-------|--------|-----------|
| **Client** | `Authorization: Bearer eyJhbGci...` | - | Env√≠a token en header |
| **Guard** | `"Bearer eyJhbGci..."` | `{ isValid: true, token: Token, userInfo: {...} }` | Extrae y valida token |
| **JWT Adapter** | `"eyJhbGci..."` | `Token { sub: "123", exp: 1703980800 }` | Decodifica sin verificar firma |
| **Token Entity** | `{ sub: "123", username: "john", exp: 1703980800 }` | `Token entity methods` | Encapsula l√≥gica del token |
| **Validation Adapter** | `"eyJhbGci..."` | `"renewed_eyJhbGci..."` | Renueva token v√≠a API externa |
| **User Adapter** | `"renewed_eyJhbGci..."` | `{ id: 1, name: "John", email: "..." }` | Obtiene info del usuario |
| **UseCase** | `"eyJhbGci..."` | `{ isValid: true, token, userInfo, message }` | Orquesta todo el proceso |
| **Controller** | `request.user, request.userInfo` | `ValidateTokenResponseDto` | Formatea respuesta final |

### üì§ Respuesta Final

```json
{
  "valid": true,
  "message": "Token validated, renewed, and user info retrieved",
  "tokenInfo": {
    "sub": "12345",
    "username": "john_doe", 
    "exp": 1703980800,
    "iat": 1703977200,
    "payload": { "sub": "12345", "username": "john_doe", "exp": 1703980800 }
  },
  "externalUserInfo": {
    "id": 1,
    "name": "Leanne Graham",
    "username": "Bret", 
    "email": "Sincere@april.biz",
    "phone": "1-770-736-8031 x56442",
    "website": "hildegard.org",
    "company": { "name": "Romaguera-Crona" },
    "address": { "street": "Kulas Light", "city": "Gwenborough" }
  }
}
```

### üö® Respuesta de Error

```json
{
  "error": true,
  "statusCode": 401,
  "errorCode": "TOKEN_EXPIRED",
  "message": "Token has expired",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### üîç Adaptadores en Detalle

#### JWT Adapter
```typescript
// Input:  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
// Output: Token { payload: { sub: "123", exp: 1703980800 } }
```

#### Token Validation Adapter  
```typescript
// Input:  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
// HTTP:   POST https://httpbin.org/post
// Output: "renewed_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### User API Adapter
```typescript
// Input:  "renewed_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
// HTTP:   GET https://jsonplaceholder.typicode.com/users/1
// Output: { id: 1, name: "Leanne Graham", email: "..." }
```

## üõ†Ô∏è Requisitos

- **Node.js** >= 18.x
- **npm** >= 8.x
- **TypeScript** >= 5.x

## üì¶ Instalaci√≥n

### 1. Clonar el Repositorio

```bash
git clone <repository-url>
cd bff-nestJS-arquitectura-hexagonal
```

### 2. Instalar Dependencias

```bash
npm install
```

#### Dependencias Principales

| Paquete | Prop√≥sito |
|---------|-----------|
| `@nestjs/core` | Framework base de NestJS |
| `@nestjs/common` | Decoradores y utilidades |
| `@nestjs/platform-express` | Adaptador para Express |
| `@nestjs/axios` | Cliente HTTP para APIs externas |
| `@nestjs/swagger` | Documentaci√≥n autom√°tica de API |
| `jsonwebtoken` | Manejo y decodificaci√≥n de JWT |
| `axios` | Cliente HTTP |
| `class-validator` | Validaci√≥n de DTOs |
| `class-transformer` | Transformaci√≥n de objetos |
| `dotenv` | Manejo de variables de entorno |
| `reflect-metadata` | Soporte para decoradores |
| `rxjs` | Programaci√≥n reactiva |

#### Dependencias de Desarrollo

| Paquete | Prop√≥sito |
|---------|-----------|
| `typescript` | Compilador TypeScript |
| `ts-node` | Ejecuci√≥n directa de TypeScript |
| `ts-node-dev` | Desarrollo con hot reload |
| `@types/*` | Definiciones de tipos |
| `tsconfig-paths` | Resoluci√≥n de paths |

## ‚öôÔ∏è Configuraci√≥n

### 1. Variables de Entorno

Crear archivo `.env` en la ra√≠z del proyecto:

```env
# Configuraci√≥n del BFF
PORT=3000

# API Externa - JSONPlaceholder (para desarrollo/testing)
EXTERNAL_API_BASE_URL=https://jsonplaceholder.typicode.com

# API de validaci√≥n de tokens (para obtener token renovado)
TOKEN_VALIDATION_API_URL=https://httpbin.org/post
```

### 2. Configuraci√≥n TypeScript

El proyecto usa `tsconfig.json` con:
- **Target**: ES2020
- **Module**: CommonJS
- **Decorators**: Habilitados
- **Strict Mode**: Activado
- **Path Mapping**: Para imports limpios

### 3. Configuraci√≥n NestJS

- **Puerto**: Configurable via `PORT` env var (default: 3000)
- **CORS**: Habilitado para requests del frontend
- **Global Prefix**: `/api` para todos los endpoints
- **Swagger**: Disponible en `/api/docs`

## üöÄ Ejecuci√≥n

### Desarrollo (Recomendado)

```bash
npm run start:dev
```
- ‚úÖ Hot reload autom√°tico
- ‚úÖ Transpilaci√≥n r√°pida
- ‚úÖ Soporte para debugging

### Producci√≥n

```bash
# Compilar
npm run build

# Ejecutar compilado
npm run start:prod
```

### Una Vez (Sin Hot Reload)

```bash
npm start
```

### Verificar que est√° funcionando

```bash
curl http://localhost:3000/api
# Deber√≠a retornar error 401 (esperado sin token)
```

## üåê API Endpoints

### GET /api

**Descripci√≥n**: Valida token JWT y retorna informaci√≥n del usuario

**Headers**:
```
Authorization: Bearer <jwt-token>
```

**Respuesta Exitosa (200)**:
```json
{
  "valid": true,
  "message": "Token validated, renewed, and user info retrieved",
  "tokenInfo": {
    "sub": "12345",
    "username": "john_doe",
    "exp": 1703980800,
    "iat": 1703980800,
    "payload": { ... }
  },
  "externalUserInfo": {
    "id": 1,
    "name": "Leanne Graham",
    "username": "Bret",
    "email": "Sincere@april.biz",
    ...
  }
}
```

**Respuestas de Error (401)**:

| Error Code | Descripci√≥n |
|------------|-------------|
| `TOKEN_NOT_PROVIDED` | Sin header Authorization |
| `INVALID_TOKEN` | JWT malformado |
| `TOKEN_EXPIRED` | Token vencido |

### GET /api/docs

**Descripci√≥n**: Documentaci√≥n interactiva Swagger UI

## üß™ Testing

### Swagger UI (Recomendado)

1. Abrir http://localhost:3000/api/docs
2. Hacer clic en "Authorize" üîí
3. Ingresar: `Bearer <tu-jwt-token>`
4. Probar el endpoint

### Postman

```
GET http://localhost:3000/api
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### cURL

```bash
curl -X GET "http://localhost:3000/api" \
  -H "Authorization: Bearer <tu-token>"
```

### Token de Prueba

Para testing, generar JWT en https://jwt.io con payload:
```json
{
  "sub": "1",
  "username": "testuser",
  "iat": 1703980800,
  "exp": 2903980800
}
```

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ main.ts                           # üöÄ Punto de entrada
‚îú‚îÄ‚îÄ app.module.ts                     # üì¶ M√≥dulo principal
‚îú‚îÄ‚îÄ presentation/                     # üé® Capa de Presentaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ controllers/
‚îÇ       ‚îî‚îÄ‚îÄ auth.controller.ts        # üéØ Endpoints HTTP
‚îú‚îÄ‚îÄ application/                      # üìã Capa de Aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ dtos/                        # üìÑ Data Transfer Objects
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts                 # üì¶ Barrel exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token-info.dto.ts        # üé´ Info del JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ external-user-info.dto.ts # üë§ Info del usuario
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-token-response.dto.ts # ‚úÖ Respuesta exitosa
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ error-response.dto.ts    # ‚ùå Respuesta de error
‚îÇ   ‚îî‚îÄ‚îÄ use-cases/
‚îÇ       ‚îî‚îÄ‚îÄ validate-token.use-case.ts # üîÑ L√≥gica de negocio
‚îú‚îÄ‚îÄ domain/                          # üèõÔ∏è Capa de Dominio
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token.entity.ts          # üé´ Entidad Token
‚îÇ   ‚îú‚îÄ‚îÄ exceptions/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token.exception.ts       # ‚ö†Ô∏è Excepciones espec√≠ficas
‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ       ‚îî‚îÄ‚îÄ token.repository.ts      # üóÇÔ∏è Interface del repositorio
‚îî‚îÄ‚îÄ infrastructure/                  # üîß Capa de Infraestructura
    ‚îú‚îÄ‚îÄ adapters/
    ‚îÇ   ‚îú‚îÄ‚îÄ jwt/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt.adapter.ts       # üîê Decodificaci√≥n JWT
    ‚îÇ   ‚îî‚îÄ‚îÄ external-api/
    ‚îÇ       ‚îú‚îÄ‚îÄ token-validation.adapter.ts # ‚úÖ Validaci√≥n externa
    ‚îÇ       ‚îî‚îÄ‚îÄ user-api.adapter.ts  # üë§ API de usuarios
    ‚îú‚îÄ‚îÄ guards/
    ‚îÇ   ‚îî‚îÄ‚îÄ token-validation.guard.ts # üõ°Ô∏è Protecci√≥n de endpoints
    ‚îî‚îÄ‚îÄ filters/
        ‚îî‚îÄ‚îÄ domain-exception.filter.ts # üö® Manejo de errores
```

## üíª Tecnolog√≠as

### Backend Framework
- **NestJS** - Framework Node.js enterprise-ready
- **Express** - Servidor HTTP subyacente
- **TypeScript** - JavaScript con tipos est√°ticos

### Validaci√≥n & Transformaci√≥n
- **Class Validator** - Validaci√≥n basada en decoradores
- **Class Transformer** - Transformaci√≥n de objetos

### HTTP & APIs
- **Axios** - Cliente HTTP para APIs externas
- **RxJS** - Programaci√≥n reactiva

### JWT & Seguridad
- **jsonwebtoken** - Manejo de JWT
- **Guards** - Protecci√≥n de rutas
- **Exception Filters** - Manejo centralizado de errores

### Documentaci√≥n
- **Swagger/OpenAPI** - Documentaci√≥n interactiva de API
- **TypeDoc** - Documentaci√≥n del c√≥digo

### Desarrollo
- **ts-node-dev** - Hot reload en desarrollo
- **dotenv** - Variables de entorno
- **ESLint** - Linting de c√≥digo
- **Prettier** - Formateo de c√≥digo

## üîß Scripts Disponibles

```bash
# Desarrollo con hot reload
npm run start:dev

# Producci√≥n (compilar + ejecutar)
npm run build && npm run start:prod

# Ejecutar una vez
npm start

# Compilar TypeScript
npm run build

# Linting
npm run lint

# Tests (por configurar)
npm test
```

## üåç Ambientes

### Desarrollo
- Puerto: 3000
- Hot reload: ‚úÖ
- Logging: Detallado
- CORS: Habilitado

### Producci√≥n
- Puerto: Variable `PORT`
- Compilaci√≥n: Optimizada
- Logging: Estructurado
- Variables: Desde archivo `.env`

## üìù Notas Importantes

1. **JWT Sin Validaci√≥n de Firma**: El BFF solo decodifica el JWT y verifica expiraci√≥n. La validaci√≥n de firma se delega a la API externa.

2. **Token Renovado**: Despu√©s de validar, se obtiene un token renovado de la API externa que se usa para llamadas posteriores.

3. **Roles en Header**: Los roles vienen en el header del JWT, no en el payload, por eso no se procesan en la entidad Token.

4. **Arquitectura Hexagonal**: El dominio no depende de nada, la aplicaci√≥n solo del dominio, y la infraestructura implementa las interfaces del dominio.

5. **Manejo de Errores**: Los errores de APIs externas se retornan tal cual, salvo que sean muy feos (por configurar).

## üöÄ Pr√≥ximos Pasos

- [ ] Tests unitarios e integraci√≥n
- [ ] Logging estructurado
- [ ] M√©tricas y monitoring
- [ ] Rate limiting
- [ ] Caching de responses
- [ ] CI/CD pipeline

## üìû Soporte

Para problemas o preguntas, revisar:
1. Logs de la aplicaci√≥n
2. Swagger docs en `/api/docs`
3. Variables de entorno en `.env`
4. Estructura de carpetas siguiendo arquitectura hexagonal

---

‚ö° **BFF listo para validar tokens y servir al frontend!**